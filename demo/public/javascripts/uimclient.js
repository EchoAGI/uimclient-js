!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).uimclient=e()}}(function(){return function r(s,c,u){function a(n,e){if(!c[n]){if(!s[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(l)return l(n,!0);var o=new Error("Cannot find module '"+n+"'");throw o.code="MODULE_NOT_FOUND",o}var i=c[n]={exports:{}};s[n][0].call(i.exports,function(e){return a(s[n][1][e]||e)},i,i.exports,r,s,c,u)}return c[n].exports}for(var l="function"==typeof require&&require,e=0;e<u.length;e++)a(u[e]);return a}({1:[function(e,n,t){var o=e('./event'),i=function(e,n){this.version=e,this.id=null,this.sid=null,this.session={},this.connector=n,this.iids=0,this.e=new o;var t=this;n.e.on('received',function(e){t.received(e)}),this.last_receive=null,this.last_receive_overdue=!1};i.prototype.heartbeat=function(e,n){var t=this.last_receive;if(this.connector.connected){if(null!==t){var o=(new Date).getTime();this.last_receive_overdue?t+n<o&&(console.log("Reconnecting because alive timeout was reached."),this.last_receive_overdue=!1,this.last_receive=null,this.connector.disconnect(!0)):t+e<o&&(this.last_receive_overdue=!0,this.sendAlive(o))}}else this.last_receive=null,this.last_receive_overdue=!1},i.prototype.send=function(e,n,t){var o={Type:e,Data:n};this.connector.send(o,t)},i.prototype.send2=function(e,t){var n={send:_.bind(function(e,n){t&&t(e,n),this.send(e,n)},this)};return this.apply(e,n)},i.prototype.request=function(e,n,t,o){var i={Type:e,Data:n};if(t){var r=''+this.iids++;i.Iid=r,this.e.one(r+'.request',t)}this.connector.send(i,o)},i.prototype.apply=function(e,n){var t=this[e];return _.bind(t,n)},i.prototype.received=function(e){var n=(new Date).getTime();this.last_receive=n,this.last_receive_overdue=!1,console.log('received: ',e);var t=e.Iid,o=e.Data,i=e.Type;if(t)this.e.triggerHandler(t+'.request',[i,o]);else switch(i){case"AccountInfo":o.Token&&(this.connector.token=o.Token),this.id=o.Id,this.sid=o.Sid,this.e.triggerHandler("received.account",[o]);break;case"IMProfile":this.e.triggerHandler("received.improfile",[o.Messages]);break;case"IMMessage":this.e.triggerHandler("received.immessage",[o.Messages]);break;case"IMContacts":this.e.triggerHandler("received.imcontacts",[o.Users]);break;default:console.log("Unhandled type received:",i,o)}},i.prototype.requestAccountInfo=function(o,i){var e={Version:this.version,Ua:this.userAgent,Name:name,Type:""};pin&&(e.Credentials={PIN:pin});var r=this;this.request("requestAccountInfo",e,function(e,n,t){"AccountInfo"===n?(o&&o(t.Account),r.e.triggerHandler("received.accountinfo",[t.Account])):i&&i(t)},!0)},i.prototype.sendMessage=function(e){return this.send('IMMessage',e)},i.prototype.doAuth=function(e,o){var n={Token:e};return this.request('doAuth',n,function(e,n,t){o(t)},!1)},n.exports=i},{"./event":3}],2:[function(e,n,t){n.exports={api_url:'ws://localhost:3001/'}},{}],3:[function(e,n,t){var o=function(){this.handlerMap={},this.onceHandlerMap={}};o.prototype.triggerHandler=function(e,n){if(this.handlerMap[e]instanceof Array)for(var t=0,o=(i=this.handlerMap[e]).length;t<o;t++)console.log('triggerHandler: ',n),i[t].apply(this,n);if(this.onceHandlerMap[e]instanceof Array){var i;for(t=0,o=(i=this.onceHandlerMap[e]).length;t<o;t++)i[t].apply(this,n);delete this.onceHandlerMap[e]}},o.prototype.on=function(e,n){var t=this.handlerMap[e];null==t&&(t=[],this.handlerMap[e]=t),t.push(n)},o.prototype.one=function(e,n){var t=this.onceHandlerMap[e];null==t&&(t=[],this.onceHandlerMap[e]=t),t.push(n)},n.exports=o},{}],4:[function(e,n,t){var o=e('./version').v,i=e('./transport/connector'),r=e('./api'),s=e('./config'),UIMClientSDK=function(){var e=new i;this.api=new r(this.version,e),e.connect(s.api_url)};UIMClientSDK.prototype.version=o,n.exports=new UIMClientSDK;var c=e('./storage');UIMClientSDK.prototype.doAuth=function(e,n){this.api.doAuth(this.token,function(e){n(e)})},UIMClientSDK.prototype.send=function(e){this.api.sendMessage(e)},UIMClientSDK.prototype.accounts=function(){return c.get('accounts')},UIMClientSDK.prototype.account=function(e){return accounts=c.get('accounts'),accounts[e]},UIMClientSDK.prototype.token=function(e){return this.token=e,this}},{"./api":1,"./config":2,"./storage":5,"./transport/connector":6,"./version":7}],5:[function(e,n,t){var o={get:function(e){return null}};n.exports=o},{}],6:[function(e,n,t){var o=e('../event'),i=function(){this.e=new o,this.error=!1,this.connected=!1,this.connecting=null,this.connecting_timeout=5e3,this.disabled=!1,this.token=null,this.queue=[]};i.prototype.connect=function(e){if(!this.disabled)if(null===this.connecting){this.error=!1,this.e.triggerHandler('connecting',[e]),this.url=e,this.token&&(e+='?t='+this.token);var n=this;this.protocol='TEXT';var t=this.conn=new WebSocket(e);t.onopen=function(e){e.target===n.conn&&n.onopen(e)},t.onerror=function(e){e.target===n.conn&&n.onerror(e)},t.onclose=function(e){e.target===n.conn&&n.onclose(e)},t.onmessage=function(e){e.target===n.conn&&n.onmessage(e)},this.connecting=window.setTimeout(function(){console.warn("Connection timeout out after",n.connecting_timeout),n.connecting_timeout<2e4&&(n.connecting_timeout+=5e3),n.e.triggerHandler("error"),n.reconnect()},this.connecting_timeout)}else console.warn("Refusing to connect while already connecting")},i.prototype.disconnect=function(e){e?this.onerror(null):this.conn.close()},i.prototype.reconnect=function(){if(this.url){this.close();var e=this.url;this.url=null,setTimeout(_.bind(function(){this.connect(e)},this),200)}},i.prototype.close=function(){if(window.clearTimeout(this.connecting),this.connecting=null,this.connected=!1,this.conn){var e=this.conn;this.conn=null,e.close()}},i.prototype.forgetAndReconnect=function(){this.token=null,this.conn&&this.connected&&this.conn.close()},i.prototype.onopen=function(e){var n;for(window.clearTimeout(this.connecting),this.connecting=null,this.connecting_timeout=5e3,console.info("Connector on connection open."),this.connected=!0,this.e.triggerHandler("open",[null,e]);0<this.queue.length&&this.connected;)n=this.queue.shift(),this.send(n)},i.prototype.onerror=function(e){window.clearTimeout(this.connecting),this.connecting=null,this.connecting_timeout=5e3,console.warn("Connector on connection error."),this.error=!0,this.close(),this.e.triggerHandler("error",[null,e])},i.prototype.onclose=function(e){window.clearTimeout(this.connecting),this.connecting=null,this.connecting_timeout=5e3,console.info("Connector on connection close.",e,this.error),this.close(),this.error||this.e.triggerHandler("close",[null,e])},i.prototype.onmessage=function(e){console.log("onmessage",e);var n=JSON.parse(e.data);this.e.triggerHandler("received",[n])},i.prototype.send=function(e,n){this.connected?this.conn.send(JSON.stringify(e)):n||(this.queue.push(e),console.warn("Queuing sending data because of not connected.",e))},i.prototype.ready=function(e){this.e.on("open",e),this.connected&&e()},n.exports=i},{"../event":3}],7:[function(e,n,t){n.exports={v:'1.0.0'}},{}]},{},[4])(4)});
//# sourceMappingURL=uimclient.js.map
